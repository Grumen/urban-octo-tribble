<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–í–∏—Ç—Ä–∏–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #222);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
        }
        .header h2 {
            margin: 0;
            font-size: 22px;
        }
        #cartBtn {
            font-size: 18px;
            padding: 6px 16px;
            background: var(--tg-theme-button-color, #2aabee);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 8px;
            padding: 8px;
        }
        .card {
            min-width: 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 16px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .card img {
            width: 220px;
            height: 220px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .card-title {
            font-weight: bold;
            margin-bottom: 4px;
            text-align: center;
        }
        .card-price {
            color: var(--tg-theme-hint-color, #888);
            margin-bottom: 8px;
        }
        .card button {
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #2aabee);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #222);
            border-radius: 12px;
            padding: 24px;
            min-width: 280px;
            max-width: 90vw;
        }
        .qty-btn { width: 30px; height: 30px; }
        .ingredients { margin: 10px 0; }
        label { margin-right: 10px; }
        .close-btn {
            float: right;
            font-size: 20px;
            cursor: pointer;
            color: var(--tg-theme-hint-color, #888);
        }
        .cart-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 8px;
            padding: 6px 8px;
        }
        .cart-item img {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            margin-right: 10px;
        }
        .cart-item button {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 18px;
            color: #d00;
            cursor: pointer;
        }
        .input-label {
            display: block;
            margin-top: 12px;
            margin-bottom: 4px;
            font-weight: bold;
        }
        .input-phone, .input-comment {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1.5px solid #ccc;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 8px;
            transition: border-color 0.2s;
        }
        .input-phone.invalid {
            border-color: #e74c3c !important;
            background: #fff0f0;
        }
        .input-phone:focus {
            border-color: #2aabee;
        }
        .input-comment:focus {
            border-color: #2aabee;
        }
        .error-msg {
            color: #e74c3c;
            font-size: 14px;
            margin-bottom: 6px;
        }
        @media (max-width: 600px) {
            .container {
                grid-template-columns: repeat(2, 1fr);
            }
            .card img {
                width: 140px;
                height: 140px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>–í–∏—Ç—Ä–∏–Ω–∞</h2>
        <button id="cartBtn" onclick="openCart()">üõí –ö–æ—Ä–∑–∏–Ω–∞ (<span id="cartCount">0</span>)</button>
    </div>
    <div class="container" id="products"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫–∞–∑–∞ -->
    <div class="modal" id="orderModal">
        <div class="modal-content" id="modalContent"></div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ—Ä–∑–∏–Ω—ã -->
    <div class="modal" id="cartModal">
        <div class="modal-content" id="cartContent"></div>
    </div>

    <script>
        Telegram.WebApp.ready();

        // –ü—Ä–∏–º–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤
        const products = [
            {
                id: 1,
                name: "–ü–∏—Ü—Ü–∞",
                price: 500,
                img: "https://img.freepik.com/free-photo/pizza-with-tomatoes-mushrooms_140725-5394.jpg?w=500",
                ingredients: [
                    {name: "—Å—ã—Ä", price: 50},
                    {name: "–±–µ–∫–æ–Ω", price: 70},
                    {name: "–≥—Ä–∏–±—ã", price: 40}
                ]
            },
            {
                id: 2,
                name: "–°—É—à–∏",
                price: 300,
                img: "https://img.freepik.com/free-photo/sushi-set-leaves_140725-5392.jpg?w=500",
                ingredients: [
                    {name: "–∏–º–±–∏—Ä—å", price: 20},
                    {name: "–≤–∞—Å–∞–±–∏", price: 15},
                    {name: "—Å–æ—É—Å", price: 10}
                ]
            },
            {
                id: 3,
                name: "–ë—É—Ä–≥–µ—Ä",
                price: 350,
                img: "https://img.freepik.com/free-photo/burger-with-cheese-tomato-lettuce_140725-5393.jpg?w=500",
                ingredients: [
                    {name: "—Å—ã—Ä", price: 30},
                    {name: "–±–µ–∫–æ–Ω", price: 40},
                    {name: "–ª—É–∫", price: 10}
                ]
            }
        ];

        let cart = [];

        function updateCartCount() {
            document.getElementById('cartCount').innerText = cart.length;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –ø–ª–∏—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
        const productsDiv = document.getElementById('products');
        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${product.img}" alt="${product.name}">
                <div class="card-title">${product.name}</div>
                <div class="card-price">${product.price}‚ÇΩ</div>
                <button onclick="openOrder(${product.id})">–ó–∞–∫–∞–∑–∞—Ç—å</button>
            `;
            productsDiv.appendChild(card);
        });

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –∑–∞–∫–∞–∑–∞
        window.openOrder = function(productId) {
            const product = products.find(p => p.id === productId);
            let qty = 1;
            let selected = [];

            function renderModal() {
                let ingrHtml = product.ingredients.map(ing =>
                    `<label><input type="checkbox" value="${ing.name}" data-price="${ing.price}" onchange="updateOrder()"> ${ing.name} (+${ing.price}‚ÇΩ)</label>`
                ).join('');
                document.getElementById('modalContent').innerHTML = `
                    <span class="close-btn" onclick="closeModal()">&times;</span>
                    <h3>${product.name}</h3>
                    <img src="${product.img}" alt="${product.name}" style="width:200px;border-radius:8px;margin-bottom:10px;">
                    <div><b>–¶–µ–Ω–∞:</b> <span id="modalPrice">${product.price}</span>‚ÇΩ</div>
                    <div><b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</b>
                        <button class="qty-btn" onclick="changeQty(-1)">-</button>
                        <span id="modalQty">${qty}</span>
                        <button class="qty-btn" onclick="changeQty(1)">+</button>
                    </div>
                    <div class="ingredients"><b>–î–æ–ø. –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</b><br>${ingrHtml}</div>
                    <button id="addToCartBtn" style="margin-top:12px;padding:10px 24px;font-size:16px;">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
                `;
                updateOrder();
                document.getElementById('addToCartBtn').onclick = function() {
                    let total = product.price + Array.from(document.querySelectorAll('#modalContent input[type=checkbox]:checked')).reduce((sum, cb) => sum + Number(cb.getAttribute('data-price')), 0);
                    cart.push({
                        item: product.name,
                        price: total * qty,
                        count: qty,
                        ingredients: selected.slice(),
                        img: product.img
                    });
                    updateCartCount();
                    closeModal();
                };
            }

            window.changeQty = function(delta) {
                qty = Math.max(1, qty + delta);
                document.getElementById('modalQty').innerText = qty;
                updateOrder();
            };

            window.updateOrder = function() {
                selected = Array.from(document.querySelectorAll('#modalContent input[type=checkbox]:checked')).map(cb => cb.value);
                let total = product.price + Array.from(document.querySelectorAll('#modalContent input[type=checkbox]:checked')).reduce((sum, cb) => sum + Number(cb.getAttribute('data-price')), 0);
                document.getElementById('modalPrice').innerText = total * qty;
            };

            document.getElementById('orderModal').style.display = 'flex';
            renderModal();
        };

        window.closeModal = function() {
            document.getElementById('orderModal').style.display = 'none';
            Telegram.WebApp.MainButton.hide();
        };

        // –û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        window.openCart = function() {
            let html = `<span class="close-btn" onclick="closeCart()">&times;</span>
                <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>`;
            if (cart.length === 0) {
                html += `<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>`;
            } else {
                let total = 0;
                html += `<div>`;
                cart.forEach((item, i) => {
                    total += item.price;
                    html += `
                        <div class="cart-item">
                            <img src="${item.img}">
                            <div>
                                <b>${item.item}</b> x${item.count}<br>
                                ${item.ingredients.length ? '–ò–Ω–≥—Ä.: ' + item.ingredients.join(', ') + '<br>' : ''}
                                <span>${item.price}‚ÇΩ</span>
                            </div>
                            <button onclick="removeFromCart(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úñÔ∏è</button>
                        </div>
                    `;
                });
                html += `</div>
                    <div style="margin-top:10px;"><b>–ò—Ç–æ–≥–æ: ${total}‚ÇΩ</b></div>
                    <label class="input-label" for="phoneInput">–¢–µ–ª–µ—Ñ–æ–Ω <span style="color:#e74c3c;">*</span></label>
                    <input type="tel" id="phoneInput" class="input-phone" placeholder="+7..." autocomplete="tel" required>
                    <div id="phoneError" class="error-msg" style="display:none;">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
                    <label class="input-label" for="commentInput">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="commentInput" class="input-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                    <button id="checkoutBtn" style="margin-top:12px;padding:10px 24px;font-size:16px;width:100%;">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
                `;
            }
            document.getElementById('cartContent').innerHTML = html;
            document.getElementById('cartModal').style.display = 'flex';

            if (cart.length > 0) {
                document.getElementById('checkoutBtn').onclick = function() {
                    const phoneInput = document.getElementById('phoneInput');
                    const commentInput = document.getElementById('commentInput');
                    const phoneError = document.getElementById('phoneError');
                    const phone = phoneInput.value.trim();

                    // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–º–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å)
                    const phonePattern = /^(\+7|8)[0-9]{10}$/;
                    if (!phonePattern.test(phone.replace(/[\s\-KATEX_INLINE_OPENKATEX_INLINE_CLOSE]/g, ''))) {
                        phoneInput.classList.add('invalid');
                        phoneError.style.display = 'block';
                        phoneInput.focus();
                        return;
                    } else {
                        phoneInput.classList.remove('invalid');
                        phoneError.style.display = 'none';
                    }

                    Telegram.WebApp.sendData(JSON.stringify({
                        cart,
                        phone,
                        comment: commentInput.value.trim()
                    }));
                };

                // –£–±–∏—Ä–∞–µ–º –∫—Ä–∞—Å–Ω—É—é —Ä–∞–º–∫—É –ø—Ä–∏ –≤–≤–æ–¥–µ
                document.getElementById('phoneInput').oninput = function() {
                    this.classList.remove('invalid');
                    document.getElementById('phoneError').style.display = 'none';
                };
            }
        };

        window.closeCart = function() {
            document.getElementById('cartModal').style.display = 'none';
        };

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            updateCartCount();
            openCart();
        };

        // –°–∫—Ä—ã—Ç—å MainButton –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≥–ª–∞–≤–Ω–æ–π
        Telegram.WebApp.MainButton.hide();
    </script>
</body>
</html>
